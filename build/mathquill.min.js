!function(){function t(){}function e(t){var e=H.call(arguments,1);return function(){return t.apply(this,e)}}function n(t,e){if(!e)throw new Error("prayer failed: "+t)}function i(t){n("a direction was passed",t===X||t===Z)}function r(e,n,i,r){function s(){u=a;var t=c.selection?"$"+c.selection.latex()+"$":"";d.select(t)}function o(){h.detach(),l.focused=!1}var c,h,l,u,p,f,d,m=e.contents().detach();return i||e.addClass("mathquill-rendered-math"),n.jQ=e.attr(P,n.id),n.revert=function(){e.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(m)},c=n.cursor=_(n),n.renderLatex(m.text()),h=n.textarea=Y('<span class="textarea"><textarea></textarea></span>'),l=h.children(),n.selectionChanged=function(){u===a&&(u=setTimeout(s)),pt(e[0])},e.bind("selectstart.mathquill",function(t){t.target!==l[0]&&t.preventDefault(),t.stopPropagation()}),f=c.blink,e.bind("mousedown.mathquill",function(n){function i(t){return c.seek(Y(t.target),t.pageX,t.pageY),(c[X]!==p[X]||c.parent!==p.parent)&&c.selectFrom(p),!1}function s(t){return delete t.target,i(t)}function o(t){p=a,c.blink=f,c.selection||(r?c.show():h.detach()),e.unbind("mousemove",i),Y(t.target.ownerDocument).unbind("mousemove",s).unbind("mouseup",o)}return setTimeout(function(){l.focus(),l.focused=!0}),c.blink=t,c.seek(Y(n.target),n.pageX,n.pageY),p=J(c.parent,c[X],c[Z]),r||l.focused||e.prepend(h),e.mousemove(i),Y(n.target.ownerDocument).mousemove(s).mouseup(o),!1}),r?(d=N(l,{container:e,key:function(t,e){c.parent.bubble("onKey",t,e)},text:function(t){c.parent.bubble("onText",t)},cut:function(t){c.selection&&setTimeout(function(){c.prepareEdit(),c.parent.bubble("redraw")}),t.stopPropagation()},paste:function(t){t="$"===t.slice(0,1)&&"$"===t.slice(-1)?t.slice(1,-1):"\\text{"+t+"}",c.writeLatex(t).show()}}),e.prepend(h),e.addClass("mathquill-editable"),i&&e.addClass("mathquill-textbox"),l.focus(function(t){c.parent||c.insAtRightEnd(n),c.parent.jQ.addClass("hasCursor"),c.selection?(c.selection.jQ.removeClass("blur"),setTimeout(n.selectionChanged)):c.show(),t.stopPropagation()}).blur(function(t){c.hide().parent.blur(),c.selection&&c.selection.jQ.addClass("blur"),t.stopPropagation()}),void e.bind("focus.mathquill blur.mathquill",function(t){l.trigger(t)}).blur()):(d=N(l,{container:e}),e.bind("cut paste",!1).bind("copy",s).prepend('<span class="selectable">$'+n.latex()+"$</span>"),void l.blur(function(){c.clearSelection(),setTimeout(o)}))}function s(t,e,n){return K(q,{ctrlSeq:t,htmlTemplate:"<"+e+" "+n+">&0</"+e+">"})}var a,o,c,h,l,u,p,f,d,m,g,b,v,w,x,j,y,k,q,Q,C,S,L,D,O,E,A,T,R,z,B,$,I,_,W,M=window.jQuery,F="mathquill-command-id",P="mathquill-block-id",U=Math.min,H=(Math.max,[].slice),K=function(t,e,n){function i(t){return"object"==typeof t}function r(t){return"function"==typeof t}function s(){}return function a(o,c){function h(){var t=new l;return r(t.init)&&t.init.apply(t,arguments),t}function l(){}var u,p,f;return c===n&&(c=o,o=Object),h.Bare=l,u=s[t]=o[t],p=l[t]=h[t]=h.p=new s,p.constructor=h,h.mixin=function(e){return l[t]=h[t]=a(h,e)[t],h},(h.open=function(t){if(f={},r(t)?f=t.call(h,p,u,h,o):i(t)&&(f=t),i(f))for(var n in f)e.call(f,n)&&(p[n]=f[n]);return r(p.init)||(p.init=o),h})(c)}}("prototype",{}.hasOwnProperty),N=function(){function e(t){var e,i=t.which||t.keyCode,r=n[i],s=[];return t.ctrlKey&&s.push("Ctrl"),t.originalEvent&&t.originalEvent.metaKey&&s.push("Meta"),t.altKey&&s.push("Alt"),t.shiftKey&&s.push("Shift"),e=r||String.fromCharCode(i),s.length||r?(s.push(e),s.join("-")):e}var n={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(n,i){function r(t){j=t,clearTimeout(y),y=setTimeout(t)}function s(e){j(),j=t,clearTimeout(y),w.val(e),e&&w[0].select()}function a(){var t=w[0];return"selectionStart"in t?t.selectionStart!==t.selectionEnd:!1}function o(t){var e=w.val();w.val(""),e&&t(e)}function c(){g(e(k),k)}function h(t){console.log("OnKey: ",t),k=t,q=null,c()}function l(t){console.log("OnKeyP: ",t),k&&q&&c(),q=t,r(u)}function u(){a()||o(m)}function p(){k=q=null}function f(t){w.focus(),r(d)}function d(){o(b)}var m,g,b,v,w,x,j,y,k=null,q=null;return i||(i={}),m=i.text||t,g=i.key||t,b=i.paste||t,v=i.cut||t,w=M(n),x=M(i.container||w),j=t,x.bind("keydown keypress input keyup focusout paste",function(){j()}),x.bind({keydown:h,keypress:l,focusout:p,cut:v,paste:f}),{select:s}}}(),G=K(function(t,e,i){function r(t,e){throw t=t?"'"+t+"'":"EOF","Parse Error: "+e+" at "+t}var s,a,o,c,h,l,u,p,f,d,m,g,b;t.init=function(t){this._=t},t.parse=function(t){function e(t,e){return e}return this.skip(b)._(t,e,r)},t.or=function(t){n("or is passed a parser",t instanceof i);var e=this;return i(function(n,i,r){function s(e){return t._(n,i,r)}return e._(n,i,s)})},t.then=function(t){var e=this;return i(function(r,s,a){function o(e,r){var o=t instanceof i?t:t(r);return n("a parser is returned",o instanceof i),o._(e,s,a)}return e._(r,o,a)})},t.many=function(){var t=this;return i(function(e,n,i){function r(t,n){return e=t,a.push(n),!0}function s(){return!1}for(var a=[];t._(e,r,s););return n(e,a)})},t.times=function(t,e){arguments.length<2&&(e=t);var n=this;return i(function(i,r,s){function a(t,e){return u.push(e),i=t,!0}function o(t,e){return h=e,i=t,!1}function c(t,e){return!1}var h,l,u=[],p=!0;for(l=0;t>l;l+=1)if(p=n._(i,a,o),!p)return s(i,h);for(;e>l&&p;l+=1)p=n._(i,a,c);return r(i,u)})},t.result=function(t){return this.then(o(t))},t.atMost=function(t){return this.times(0,t)},t.atLeast=function(t){var e=this;return e.times(t).then(function(t){return e.many().map(function(e){return t.concat(e)})})},t.map=function(t){return this.then(function(e){return o(t(e))})},t.skip=function(t){return this.then(function(e){return t.result(e)})},s=this.string=function(t){var e=t.length,n="expected '"+t+"'";return i(function(i,r,s){var a=i.slice(0,e);return a===t?r(i.slice(e),a):s(i,n)})},a=this.regex=function(t){n("regexp parser is anchored","^"===t.toString().charAt(1));var e="expected "+t;return i(function(n,i,r){var s,a=t.exec(n);return a?(s=a[0],i(n.slice(s.length),s)):r(n,e)})},o=i.succeed=function(t){return i(function(e,n){return n(e,t)})},c=i.fail=function(t){return i(function(e,n,i){return i(e,t)})},h=i.letter=a(/^[a-z]/i),l=i.letters=a(/^[a-z]*/i),u=i.digit=a(/^[0-9]/),p=i.digits=a(/^[0-9]*/),f=i.whitespace=a(/^\s+/),d=i.optWhitespace=a(/^\s*/),m=i.any=i(function(t,e,n){return t?e(t.slice(1),t.charAt(0)):n(t,"expected any character")}),g=i.all=i(function(t,e,n){return e("",t)}),b=i.eof=i(function(t,e,n){return t?n(t,"expected EOF"):e(t,t)})}),X=-1,Z=1,Y=K(M,function(t){t.insDirOf=function(t,e){return t===X?this.insertBefore(e.first()):this.insertAfter(e.last())},t.insAtDirEnd=function(t,e){return t===X?this.prependTo(e):this.appendTo(e)}}),J=K(function(t){t.parent=0,t[X]=0,t[Z]=0,t.init=function(t,e,n){this.parent=t,this[X]=e,this[Z]=n}}),V=K(function(t){t[X]=0,t[Z]=0,t.parent=0,t.init=function(){this.ends={},this.ends[X]=0,this.ends[Z]=0},t.children=function(){return tt(this.ends[X],this.ends[Z])},t.eachChild=function(t){return this.children().each(t)},t.foldChildren=function(t,e){return this.children().fold(t,e)},t.adopt=function(t,e,n){return tt(this,this).adopt(t,e,n),this},t.disown=function(){return tt(this,this).disown(),this}}),tt=K(function(t){function e(t,e,i){n("a parent is always present",t),n("leftward is properly set up",function(){return e?e[Z]===i&&e.parent===t:t.ends[X]===i}()),n("rightward is properly set up",function(){return i?i[X]===e&&i.parent===t:t.ends[Z]===e}())}t.init=function(t,e){n("no half-empty fragments",!t==!e),this.ends={},t&&(n("left end node is passed to Fragment",t instanceof V),n("right end node is passed to Fragment",e instanceof V),n("leftEnd and rightEnd have the same parent",t.parent===e.parent),this.ends[X]=t,this.ends[Z]=e)},t.adopt=function(t,n,i){var r,s,a;return e(t,n,i),r=this,r.disowned=!1,(s=r.ends[X])?(a=r.ends[Z],n||(t.ends[X]=s),i?i[X]=a:t.ends[Z]=a,r.ends[Z][Z]=i,r.each(function(e){e[X]=n,e.parent=t,n&&(n[Z]=e),n=e}),r):this},t.disown=function(){var t,n,i=this,r=i.ends[X];return!r||i.disowned?i:(i.disowned=!0,t=i.ends[Z],n=r.parent,e(n,r[X],r),e(n,t,t[Z]),r[X]?r[X][Z]=t[Z]:n.ends[X]=t[Z],t[Z]?t[Z][X]=r[X]:n.ends[Z]=r[X],i)},t.each=function(t){var e=this,n=e.ends[X];if(!n)return e;for(;n!==e.ends[Z][Z]&&t.call(e,n)!==!1;n=n[Z]);return e},t.fold=function(t,e){return this.each(function(n){t=e.call(this,t,n)}),t}}),et=function(){var t=0;return function(){return t+=1}}(),nt=K(V,function(t,e){t.init=function(t){e.init.call(this),this.id=et(),nt[this.id]=this},t.toString=function(){return"[MathElement "+this.id+"]"},t.bubble=function(t){var e,n,i=H.call(arguments,1);for(e=this;e&&(n=e[t]&&e[t].apply(e,i),n!==!1);e=e.parent);return this},t.postOrder=function(t){var e,n=H.call(arguments,1);"string"==typeof t&&(e=t,t=function(t){e in t&&t[e].apply(t,n)}),function i(e){e.eachChild(i),t(e)}(this)},t.jQ=Y(),t.jQadd=function(t){this.jQ=this.jQ.add(t)},this.jQize=function(t){var e=Y(t);return e.find("*").andSelf().each(function(){var t=Y(this),e=t.attr("mathquill-command-id"),n=t.attr("mathquill-block-id");e&&nt[e].jQadd(t),n&&nt[n].jQadd(t)}),e},t.finalizeInsert=function(){var t=this;t.postOrder("finalizeTree"),t.postOrder("blur"),t.postOrder("respace"),t[Z].respace&&t[Z].respace(),t[X].respace&&t[X].respace(),t.postOrder("redraw"),t.bubble("redraw")}}),it=K(nt,function(e,i){e.init=function(t,e,n){var r=this;i.init.call(r),r.ctrlSeq||(r.ctrlSeq=t),e&&(r.htmlTemplate=e),n&&(r.textTemplate=n)},e.replaces=function(t){t.disown(),this.replacedFragment=t},e.isEmpty=function(){return this.foldChildren(!0,function(t,e){return t&&e.isEmpty()})},e.parser=function(){var t=I.block,e=this;return t.times(e.numBlocks()).map(function(t){e.blocks=t;for(var n=0;n<t.length;n+=1)t[n].adopt(e,e.ends[Z],0);return e})},e.createLeftOf=function(t){var e=this,n=e.replacedFragment;e.createBlocks(),nt.jQize(e.html()),n&&(n.adopt(e.ends[X],0,0),n.jQ.appendTo(e.ends[X].jQ)),t.jQ.before(e.jQ),t[X]=e.adopt(t.parent,t[X],t[Z]),e.finalizeInsert(t),e.placeCursor(t)},e.createBlocks=function(){var t,e,n=this,i=n.numBlocks(),r=n.blocks=Array(i);for(t=0;i>t;t+=1)e=r[t]=st(),e.adopt(n,n.ends[Z],0)},e.respace=t,e.placeCursor=function(t){t.insAtRightEnd(this.foldChildren(this.ends[X],function(t,e){return t.isEmpty()?t:e}))},e.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(t){delete nt[t.id]}),this},e.numBlocks=function(){var t=this.htmlTemplate.match(/&\d+/g);return t?t.length:0},e.html=function(){var t,e,i,r=this,s=r.blocks,a=" mathquill-command-id="+r.id,o=r.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);for(n("no unmatched angle brackets",o.join("")===this.htmlTemplate),t=0,e=o[0];e;t+=1,e=o[t])if("/>"===e.slice(-2))o[t]=e.slice(0,-2)+a+"/>";else if("<"===e.charAt(0)){n("not an unmatched top-level close tag","/"!==e.charAt(1)),o[t]=e.slice(0,-1)+a+">",i=1;do t+=1,e=o[t],n("no missing close tags",e),"</"===e.slice(0,2)?i-=1:"<"===e.charAt(0)&&"/>"!==e.slice(-2)&&(i+=1);while(i>0)}return o.join("").replace(/>&(\d+)/g,function(t,e){return" mathquill-block-id="+s[e].id+">"+s[e].join("html")})},e.latex=function(){return this.foldChildren(this.ctrlSeq,function(t,e){return t+"{"+(e.latex()||" ")+"}"})},e.textTemplate=[""],e.text=function(){var t=this,e=0;return t.foldChildren(t.textTemplate[e],function(n,i){e+=1;var r=i.text();return n&&"("===t.textTemplate[e]&&"("===r[0]&&")"===r.slice(-1)?n+r.slice(1,-1)+t.textTemplate[e]:n+i.text()+(t.textTemplate[e]||"")})}}),rt=K(it,function(e,n){e.init=function(t,e,i){i||(i=t&&t.length>1?t.slice(1):t),n.init.call(this,t,e,[i])},e.parser=function(){return G.succeed(this)},e.numBlocks=function(){return 0},e.replaces=function(t){t.remove()},e.createBlocks=t,e.latex=function(){return this.ctrlSeq},e.text=function(){return this.textTemplate},e.placeCursor=t,e.isEmpty=function(){return!0}}),st=K(nt,function(t){t.join=function(t){return this.foldChildren("",function(e,n){return e+n[t]()})},t.latex=function(){return this.join("latex")},t.text=function(){return this.ends[X]===this.ends[Z]?this.ends[X].text():"("+this.join("text")+")"},t.isEmpty=function(){return 0===this.ends[X]&&0===this.ends[Z]},t.write=function(t,e,n){var i;i=e.match(/^[a-eg-zA-Z]$/)?O(e):(i=lt[e]||ut[e])?i(e):E(e),n&&i.replaces(n),i.createLeftOf(t)},t.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},t.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),at=K(tt,function(t,e){t.init=function(t,n){e.init.call(this,t,n||t),this.jQ=this.fold(Y(),function(t,e){return e.jQ.add(t)})},t.latex=function(){return this.fold("",function(t,e){return t+e.latex()})},t.remove=function(){return this.jQ.remove(),this.each(function(t){t.postOrder(function(t){delete nt[t.id]})}),this.disown()}}),ot=K(st,function(t,e){t.latex=function(){return e.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/gi,"$1")},t.text=function(){return this.foldChildren("",function(t,e){return t+e.text()})},t.renderLatex=function(t){var e=this.jQ;e.children().slice(1).remove(),this.ends[X]=this.ends[Z]=0,delete this.cursor.selection,this.cursor.insAtRightEnd(this).writeLatex(t)},t.onKey=function(t,e){var n;switch(t){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":for(;this.cursor[X]||this.cursor.selection;)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace();break;case"Esc":case"Tab":case"Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return void("Spacebar"===t&&e.preventDefault());this.cursor.prepareMove(),n[Z]?this.cursor.insAtLeftEnd(n[Z]):this.cursor.insRightOf(n.parent);break;case"Shift-Tab":case"Shift-Esc":case"Shift-Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return void("Shift-Spacebar"===t&&e.preventDefault());this.cursor.prepareMove(),n[X]?this.cursor.insAtRightEnd(n[X]):this.cursor.insLeftOf(n.parent);break;case"Enter":break;case"End":this.cursor.prepareMove().insAtRightEnd(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().insAtRightEnd(this);break;case"Shift-End":for(;this.cursor[Z];)this.cursor.selectRight();break;case"Ctrl-Shift-End":for(;this.cursor[Z]||this.cursor.parent!==this;)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().insAtLeftEnd(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().insAtLeftEnd(this);break;case"Shift-Home":for(;this.cursor[X];)this.cursor.selectLeft();break;case"Ctrl-Shift-Home":for(;this.cursor[X]||this.cursor.parent!==this;)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor[X])for(;this.cursor[X];)this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor[Z])for(;this.cursor[Z];)this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":for(;this.cursor[Z]||this.cursor.selection;)this.cursor.deleteForward();break;case"Shift-Del":case"Del":this.cursor.deleteForward();break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;for(this.cursor.prepareMove().insAtRightEnd(this);this.cursor[X];)this.cursor.selectLeft();break;default:return!1}return e.preventDefault(),!1},t.onText=function(t){return this.cursor.write(t),!1}}),ct=K(it,function(t,e){t.init=function(t){e.init.call(this,"$"),this.cursor=t},t.htmlTemplate='<span class="mathquill-rendered-math">&0</span>',t.createBlocks=function(){this.ends[X]=this.ends[Z]=ot(),this.blocks=[this.ends[X]],this.ends[X].parent=this,this.ends[X].cursor=this.cursor,this.ends[X].write=function(t,e,n){"$"!==e?st.prototype.write.call(this,t,e,n):this.isEmpty()?(t.insRightOf(this.parent).backspace().show(),E("\\$","$").createLeftOf(t)):t[Z]?t[X]?st.prototype.write.call(this,t,e,n):t.insLeftOf(this.parent):t.insRightOf(this.parent)}},t.latex=function(){return"$"+this.ends[X].latex()+"$"}}),ht=K(st,function(t){t.renderLatex=function(t){var e,n,i,r,s,a,o,c,h,l,u,p=this,f=p.cursor;if(p.jQ.children().slice(1).remove(),p.ends[X]=p.ends[Z]=0,delete f.selection,f.show().insAtRightEnd(p),e=G.regex,n=G.string,i=G.eof,r=G.all,s=n("$").then(I).skip(n("$").or(i)).map(function(t){var e,n=ct(f);return n.createBlocks(),e=n.ends[X],t.children().adopt(e,0,0),n}),a=n("\\$").result("$"),o=a.or(e(/^[^$]/)).map(E),c=s.or(o).many(),h=c.skip(i).or(r.result(!1)).parse(t)){for(l=0;l<h.length;l+=1)h[l].adopt(p,p.ends[Z],0);u=p.join("html"),nt.jQize(u).appendTo(p.jQ),this.finalizeInsert()}},t.onKey=function(t){"Spacebar"!==t&&"Shift-Spacebar"!==t&&ot.prototype.onKey.apply(this,arguments)},t.onText=ot.prototype.onText,t.write=function(t,e,n){if(n&&n.remove(),"$"===e)ct(t).createLeftOf(t);else{var i;"<"===e?i="&lt;":">"===e&&(i="&gt;"),E(e,i).createLeftOf(t)}}}),lt={},ut={},pt=t,ft=document.createElement("div"),dt=ft.style,mt={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(h in mt)if(h in dt){c=h;break}c?o=function(t,e,n){t.css(c,"scale("+e+","+n+")")}:"filter"in dt?(pt=function(t){t.className=t.className},o=function(t,e,n){function i(){t.css("marginRight",(r.width()-1)*(e-1)/e+"px")}var r,s;e/=1+(n-1)/2,t.css("fontSize",n+"em"),t.hasClass("matrixed-container")||t.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>'),r=t.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+e+",SizingMethod='auto expand')"),i(),s=setInterval(i),Y(window).load(function(){clearTimeout(s),i()})}):o=function(t,e,n){t.css("fontSize",n+"em")},l=K(it,function(t,e){t.init=function(t,n,i){e.init.call(this,t,"<"+n+" "+i+">&0</"+n+">")}}),ut.mathrm=e(l,"\\mathrm","span",'class="roman font"'),ut.mathit=e(l,"\\mathit","i",'class="font"'),ut.mathbf=e(l,"\\mathbf","b",'class="font"'),ut.mathsf=e(l,"\\mathsf","span",'class="sans-serif font"'),ut.mathtt=e(l,"\\mathtt","span",'class="monospace font"'),ut.underline=e(l,"\\underline","span",'class="non-leaf underline"'),ut.overline=ut.bar=e(l,"\\overline","span",'class="non-leaf overline"'),u=K(it,function(t,e){t.init=function(t,n,i){e.init.call(this,t,"<"+n+' class="non-leaf">&0</'+n+">",[i])},t.finalizeTree=function(){function t(t){var e=this.parent,n=t;do{if(n[Z])return t.insLeftOf(e),!1;n=n.parent.parent}while(n!==e);return t.insRightOf(e),!1}n("SupSub is only _ and ^","^"===this.ctrlSeq||"_"===this.ctrlSeq),"_"===this.ctrlSeq?(this.down=this.ends[X],this.ends[X].up=t):(this.up=this.ends[X],this.ends[X].down=t)},t.latex=function(){var t=this.ends[X].latex();return 1===t.length?this.ctrlSeq+t:this.ctrlSeq+"{"+(t||" ")+"}"},t.redraw=function(){this[X]&&this[X].respace(),this[X]instanceof u||(this.respace(),!this[Z]||this[Z]instanceof u||this[Z].respace())},t.respace=function(){if("\\int "===this[X].ctrlSeq||this[X]instanceof u&&this[X].ctrlSeq!=this.ctrlSeq&&this[X][X]&&"\\int "===this[X][X].ctrlSeq?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),this.respaced=this[X]instanceof u&&this[X].ctrlSeq!=this.ctrlSeq&&!this[X].respaced,this.respaced){var t=+this.jQ.css("fontSize").slice(0,-2),e=this[X].jQ.outerWidth(),n=this.jQ.outerWidth();this.jQ.css({left:(this.limit&&"_"===this.ctrlSeq?-.25:0)-e/t+"em",marginRight:.1-U(n,e)/t+"em"})}else this.limit&&"_"===this.ctrlSeq?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this[Z]instanceof u&&this[Z].respace(),this}}),ut.subscript=ut._=e(u,"_","sub","_"),ut.superscript=ut.supscript=ut["^"]=e(u,"^","sup","**"),p=ut.frac=ut.dfrac=ut.cfrac=ut.fraction=K(it,function(t,e){t.ctrlSeq="\\frac",t.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',t.textTemplate=["(","/",")"],t.finalizeTree=function(){this.up=this.ends[Z].up=this.ends[X],this.down=this.ends[X].down=this.ends[Z]}}),f=ut.mfrac=K(p,function(t,e){t.htmlTemplate='<span class="non-leaf">&0</span><span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',t.textTemplate=["(","/",")"],t.latex=function(){return"\\sqrt["+this.ends[X].latex()+"]{"+this.ends[Z].latex()+"}"}}),d=ut.over=lt["/"]=K(p,function(t,e){t.createLeftOf=function(t){if(!this.replacedFragment){for(var n=t[X];n&&!(n instanceof R||n instanceof q||n instanceof B||/^[,;:]$/.test(n.ctrlSeq));)n=n[X];n instanceof B&&n[Z]instanceof u&&(n=n[Z],n[Z]instanceof u&&n[Z].ctrlSeq!=n.ctrlSeq&&(n=n[Z])),n!==t[X]&&(this.replaces(at(n[Z]||t.parent.ends[X],t[X])),t[X]=n)}e.createLeftOf.call(this,t)}}),m=ut.sqrt=ut["√"]=K(it,function(t,e){t.ctrlSeq="\\sqrt",t.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',t.textTemplate=["sqrt(",")"],t.parser=function(){return I.optBlock.then(function(t){return I.block.map(function(e){var n=b();return n.blocks=[t,e],t.adopt(n,0,0),e.adopt(n,t,0),n})}).or(e.parser.call(this))},t.redraw=function(){var t=this.ends[Z].jQ;o(t.prev(),1,t.innerHeight()/+t.css("fontSize").slice(0,-2)-.1)}}),g=ut.vec=K(it,function(t,e){t.ctrlSeq="\\vec",t.htmlTemplate='<span class="non-leaf"><span class="vector-prefix">&rarr;</span><span class="vector-stem">&0</span></span>',t.textTemplate=["vec(",")"]}),b=ut.nthroot=K(m,function(t,e){t.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',t.textTemplate=["sqrt[","](",")"],t.latex=function(){return"\\sqrt["+this.ends[X].latex()+"]{"+this.ends[Z].latex()+"}"}}),v=K(it,function(t,e){t.init=function(t,n,i,r){e.init.call(this,"\\left"+i,'<span class="non-leaf"><span class="scaled paren">'+t+'</span><span class="non-leaf">&0</span><span class="scaled paren">'+n+"</span></span>",[t,n]),this.end="\\right"+r},t.jQadd=function(){e.jQadd.apply(this,arguments);var t=this.jQ;this.bracketjQs=t.children(":first").add(t.children(":last"))},t.latex=function(){return this.ctrlSeq+this.ends[X].latex()+this.end},t.redraw=function(){var t=this.ends[X].jQ,e=t.outerHeight()/+t.css("fontSize").slice(0,-2);o(this.bracketjQs,U(1+.2*(e-1),1.2),1.05*e)}}),ut.left=K(it,function(t){t.parser=function(){var t=G.regex,e=G.string,n=G.succeed,i=G.optWhitespace;return i.then(t(/^(?:[([|]|\\\{)/)).then(function(r){"\\"===r.charAt(0)&&(r=r.slice(1));var s=lt[r]();return I.map(function(t){s.blocks=[t],t.adopt(s,0,0)}).then(e("\\right")).skip(i).then(t(/^(?:[\])|]|\\\})/)).then(function(t){return t.slice(-1)!==s.end.slice(-1)?G.fail("open doesn't match close"):n(s)})})}}),ut.right=K(it,function(t){t.parser=function(){return G.fail("unmatched \\right")}}),ut.lbrace=lt["{"]=e(v,"{","}","\\{","\\}"),ut.langle=ut.lang=e(v,"&lang;","&rang;","\\langle ","\\rangle "),w=K(v,function(t,e){t.createLeftOf=function(t){t[Z]||!t.parent.parent||t.parent.parent.end!==this.end||this.replacedFragment?e.createLeftOf.call(this,t):t.insRightOf(t.parent.parent)},t.placeCursor=function(t){this.ends[X].blur(),t.insRightOf(this)}}),ut.rbrace=lt["}"]=e(w,"{","}","\\{","\\}"),ut.rangle=ut.rang=e(w,"&lang;","&rang;","\\langle ","\\rangle "),x=function(t,e){t.init=function(t,n){e.init.call(this,t,n,t,n)}},j=K(v,x),ut.lparen=lt["("]=e(j,"(",")"),ut.lbrack=ut.lbracket=lt["["]=e(j,"[","]"),y=K(w,x),ut.rparen=lt[")"]=e(y,"(",")"),ut.rbrack=ut.rbracket=lt["]"]=e(y,"[","]"),k=ut.lpipe=ut.rpipe=lt["|"]=K(j,function(t,e){t.init=function(){e.init.call(this,"|","|")},t.createLeftOf=w.prototype.createLeftOf}),q=lt.$=ut.text=ut.textnormal=ut.textrm=ut.textup=ut.textmd=K(it,function(t,e){t.ctrlSeq="\\text",t.htmlTemplate='<span class="text">&0</span>',t.replaces=function(t){t instanceof at?this.replacedText=t.remove().jQ.text():"string"==typeof t&&(this.replacedText=t)},t.textTemplate=['"','"'],t.parser=function(){var t=this,e=G.string,n=G.regex,i=G.optWhitespace;return i.then(e("{")).then(n(/^[^}]*/)).skip(e("}")).map(function(e){var n,i,r;for(t.createBlocks(),n=t.ends[X],i=0;i<e.length;i+=1)r=E(e.charAt(i)),r.adopt(n,n.ends[Z],0);return t})},t.createBlocks=function(){this.ends[X]=this.ends[Z]=Q(),this.blocks=[this.ends[X]],this.ends[X].parent=this},t.finalizeInsert=function(){this.ends[X].blur=function(){return delete this.blur,this},e.finalizeInsert.call(this)},t.createLeftOf=function(t){if(e.createLeftOf.call(this,this.cursor=t),this.replacedText)for(var n=0;n<this.replacedText.length;n+=1)this.ends[X].write(t,this.replacedText.charAt(n))}}),Q=K(st,function(t,e){t.onKey=function(t,e){return"Spacebar"===t||"Shift-Spacebar"===t?!1:void 0},t.deleteOutOf=function(t,e){this.isEmpty()&&e.insRightOf(this.parent)},t.write=function(t,e,n){var i,r;return n&&n.remove(),"$"!==e?("<"===e?i="&lt;":">"===e&&(i="&gt;"),E(e,i).createLeftOf(t)):this.isEmpty()?(t.insRightOf(this.parent).backspace(),E("\\$","$").createLeftOf(t)):t[Z]?t[X]?(r=q(),r.replaces(at(t[Z],this.ends[Z])),t.insRightOf(this.parent),r.adopt=function(){delete this.adopt,this.adopt.apply(this,arguments),this[X]=0},r.createLeftOf(t),r[X]=this.parent,t.insLeftOf(r)):t.insLeftOf(this.parent):t.insRightOf(this.parent),!1},t.blur=function(){if(this.jQ.removeClass("hasCursor"),this.isEmpty()){var t=this.parent,e=t.cursor;e.parent===this?this.jQ.addClass("empty"):(e.hide(),t.remove(),e[Z]===t?e[Z]=t[Z]:e[X]===t&&(e[X]=t[X]),e.show().parent.bubble("redraw"))}return this},t.focus=function(){var t,n,i,r;return e.focus.call(this),t=this.parent,t[Z].ctrlSeq===t.ctrlSeq?(n=this,i=t.cursor,r=t[Z].ends[X],r.eachChild(function(t){t.parent=n,t.jQ.appendTo(n.jQ)}),this.ends[Z]?this.ends[Z][Z]=r.ends[X]:this.ends[X]=r.ends[X],r.ends[X][X]=this.ends[Z],this.ends[Z]=r.ends[Z],r.parent.remove(),i[X]?i.insRightOf(i[X]):i.insAtLeftEnd(this),i.parent.bubble("redraw")):t[X].ctrlSeq===t.ctrlSeq&&(i=t.cursor,i[X]?t[X].ends[X].focus():i.insAtRightEnd(t[X].ends[X])),this}}),ut.em=ut.italic=ut.italics=ut.emph=ut.textit=ut.textsl=s("\\textit","i",'class="text"'),ut.strong=ut.bold=ut.textbf=s("\\textbf","b",'class="text"'),ut.sf=ut.textsf=s("\\textsf","span",'class="sans-serif text"'),ut.tt=ut.texttt=s("\\texttt","span",'class="monospace text"'),ut.textsc=s("\\textsc","span",'style="font-variant:small-caps" class="text"'),ut.uppercase=s("\\uppercase","span",'style="text-transform:uppercase" class="text"'),ut.lowercase=s("\\lowercase","span",'style="text-transform:lowercase" class="text"'),C=lt["\\"]=K(it,function(t,e){t.ctrlSeq="\\",t.replaces=function(t){this._replacedFragment=t.disown(),this.isEmpty=function(){return!1}},t.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',t.textTemplate=["\\"],t.createBlocks=function(){e.createBlocks.call(this),this.ends[X].focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.ends[X].blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},t.createLeftOf=function(t){if(e.createLeftOf.call(this,t),this.cursor=t.insAtRightEnd(this.ends[X]),this._replacedFragment){var n=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(t){return Y(t.target=n).trigger(t),!1}).insertBefore(this.jQ).add(this.jQ)}this.ends[X].write=function(t,e,n){n&&n.remove(),e.match(/[a-z]/i)?E(e).createLeftOf(t):(this.parent.renderCommand(),"\\"===e&&this.isEmpty()||this.parent.parent.write(t,e))}},t.latex=function(){return"\\"+this.ends[X].latex()+" "},t.onKey=function(t,e){return"Tab"===t||"Enter"===t||"Spacebar"===t?(this.renderCommand(),e.preventDefault(),!1):void 0},t.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this[Z]?this.cursor.insLeftOf(this[Z]):this.cursor.insAtRightEnd(this.parent);var t=this.ends[X].latex();t||(t="backslash"),this.cursor.insertCmd(t,this._replacedFragment)}}),S=ut.binom=ut.binomial=K(it,function(t,e){t.ctrlSeq="\\binom",t.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',t.textTemplate=["choose(",",",")"],t.redraw=function(){var t=this.jQ.eq(1),e=t.outerHeight()/+t.css("fontSize").slice(0,-2),n=this.jQ.filter(".paren");o(n,U(1+.2*(e-1),1.2),1.05*e)}}),L=ut.choose=K(S,function(t){t.createLeftOf=d.prototype.createLeftOf}),D=ut.vector=K(it,function(t,e){t.ctrlSeq="\\vector",t.htmlTemplate='<span class="array"><span>&0</span></span>',t.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(t,e){return t.push(e.latex()),t}).join("\\\\")+"\\end{matrix}"},t.text=function(){return"["+this.foldChildren([],function(t,e){return t.push(e.text()),t}).join()+"]"},t.createLeftOf=function(t){e.createLeftOf.call(this,this.cursor=t)},t.onKey=function(t,e){var n,i=this.cursor.parent;if(i.parent===this){if("Enter"===t)return n=st(),n.parent=this,n.jQ=Y("<span></span>").attr(P,n.id).insertAfter(i.jQ),i[Z]?i[Z][X]=n:this.ends[Z]=n,n[Z]=i[Z],i[Z]=n,n[X]=i,this.bubble("redraw").cursor.insAtRightEnd(n),e.preventDefault(),!1;if("Tab"===t&&!i[Z])return i.isEmpty()?i[X]?(this.cursor.insRightOf(this),delete i[X][Z],this.ends[Z]=i[X],i.jQ.remove(),this.bubble("redraw"),e.preventDefault(),!1):void 0:(n=st(),n.parent=this,n.jQ=Y("<span></span>").attr(P,n.id).appendTo(this.jQ),this.ends[Z]=n,i[Z]=n,n[X]=i,this.bubble("redraw").cursor.insAtRightEnd(n),e.preventDefault(),!1);if(8===e.which){if(i.isEmpty())return i[X]?(this.cursor.insAtRightEnd(i[X]),i[X][Z]=i[Z]):(this.cursor.insLeftOf(this),this.ends[X]=i[Z]),i[Z]?i[Z][X]=i[X]:this.ends[Z]=i[X],i.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),e.preventDefault(),!1;if(!this.cursor[X])return e.preventDefault(),!1}}}}),ut.editable=K(ct,function(t,e){t.init=function(){it.prototype.init.call(this,"\\editable")},t.jQadd=function(){var t,n,i=this;e.jQadd.apply(i,arguments),t=i.ends[X].disown(),n=i.jQ.children().detach(),i.ends[X]=i.ends[Z]=ot(),i.blocks=[i.ends[X]],i.ends[X].parent=i,r(i.jQ,i.ends[X],!1,!0),i.cursor=i.ends[X].cursor,t.children().adopt(i.ends[X],0,0),n.appendTo(i.ends[X].jQ),i.ends[X].cursor.insAtRightEnd(i.ends[X])},t.latex=function(){return this.ends[X].latex()},t.text=function(){return this.ends[X].text()}}),ut.f=e(rt,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>'),O=K(rt,function(t,e){t.init=function(t,n){e.init.call(this,t,"<var>"+(n||t)+"</var>")},t.text=function(){var t=this.ctrlSeq;return!this[X]||this[X]instanceof O||this[X]instanceof R||(t="*"+t),!this[Z]||this[Z]instanceof R||"^"===this[Z].ctrlSeq||(t+="*"),t}}),E=K(rt,function(t,e){t.init=function(t,n){e.init.call(this,t,"<span>"+(n||t)+"</span>")}}),lt[" "]=e(E,"\\:"," "),ut.prime=lt["'"]=e(E,"'","&prime;"),A=K(rt,function(t,e){t.init=function(t,n){e.init.call(this,t,'<span class="nonSymbola">'+(n||t)+"</span>")}}),ut["@"]=A,ut["&"]=e(A,"\\&","&amp;"),ut["%"]=e(A,"\\%","%"),ut.alpha=ut.beta=ut.gamma=ut.delta=ut.zeta=ut.eta=ut.theta=ut.iota=ut.kappa=ut.mu=ut.nu=ut.xi=ut.rho=ut.sigma=ut.tau=ut.chi=ut.psi=ut.omega=K(O,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),ut.phi=e(O,"\\phi ","&#981;"),ut.phiv=ut.varphi=e(O,"\\varphi ","&phi;"),ut.epsilon=e(O,"\\epsilon ","&#1013;"),ut.epsiv=ut.varepsilon=e(O,"\\varepsilon ","&epsilon;"),ut.piv=ut.varpi=e(O,"\\varpi ","&piv;"),ut.sigmaf=ut.sigmav=ut.varsigma=e(O,"\\varsigma ","&sigmaf;"),ut.thetav=ut.vartheta=ut.thetasym=e(O,"\\vartheta ","&thetasym;"),ut.upsilon=ut.upsi=e(O,"\\upsilon ","&upsilon;"),ut.gammad=ut.Gammad=ut.digamma=e(O,"\\digamma ","&#989;"),
ut.kappav=ut.varkappa=e(O,"\\varkappa ","&#1008;"),ut.rhov=ut.varrho=e(O,"\\varrho ","&#1009;"),ut.pi=ut["π"]=e(A,"\\pi ","&pi;"),ut.lambda=e(A,"\\lambda ","&lambda;"),ut.Upsilon=ut.Upsi=ut.upsih=ut.Upsih=e(rt,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),ut.Gamma=ut.Delta=ut.Theta=ut.Lambda=ut.Xi=ut.Pi=ut.Sigma=ut.Phi=ut.Psi=ut.Omega=ut.forall=K(E,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),T=K(it,function(t){t.init=function(t){this.latex=t},t.createLeftOf=function(t){t.writeLatex(this.latex)},t.parser=function(){var t=I.parse(this.latex).children();return G.succeed(t)}}),ut["¹"]=e(T,"^1"),ut["²"]=e(T,"^2"),ut["³"]=e(T,"^3"),ut["¼"]=e(T,"\\frac14"),ut["½"]=e(T,"\\frac12"),ut["¾"]=e(T,"\\frac34"),R=K(rt,function(t,e){t.init=function(t,n,i){e.init.call(this,t,'<span class="binary-operator">'+n+"</span>",i)}}),z=K(R,function(t){t.init=E.prototype.init,t.respace=function(){return this[X]?this[X]instanceof R&&this[Z]&&!(this[Z]instanceof R)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this}}),ut["+"]=e(z,"+","+"),ut["–"]=ut["-"]=e(z,"-","&minus;"),ut["±"]=ut.pm=ut.plusmn=ut.plusminus=e(z,"\\pm ","&plusmn;"),ut.mp=ut.mnplus=ut.minusplus=e(z,"\\mp ","&#8723;"),lt["*"]=ut.sdot=ut.cdot=e(R,"\\cdot ","&middot;"),ut["="]=e(R,"=","="),ut["<"]=e(R,"<","&lt;"),ut[">"]=e(R,">","&gt;"),ut.notin=ut.sim=ut.cong=ut.equiv=ut.oplus=ut.otimes=K(R,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),ut.times=e(R,"\\times ","&times;","[x]"),ut["÷"]=ut.div=ut.divide=ut.divides=e(R,"\\div ","&divide;","[/]"),ut["≠"]=ut.ne=ut.neq=e(R,"\\ne ","&ne;"),ut.ast=ut.star=ut.loast=ut.lowast=e(R,"\\ast ","&lowast;"),ut.therefor=ut.therefore=e(R,"\\therefore ","&there4;"),ut.cuz=ut.because=e(R,"\\because ","&#8757;"),ut.prop=ut.propto=e(R,"\\propto ","&prop;"),ut["≈"]=ut.asymp=ut.approx=e(R,"\\approx ","&asymp;"),ut.lt=e(R,"<","&lt;"),ut.gt=e(R,">","&gt;"),ut["≤"]=ut.le=ut.leq=e(R,"\\le ","&le;"),ut["≥"]=ut.ge=ut.geq=e(R,"\\ge ","&ge;"),ut.isin=ut["in"]=e(R,"\\in ","&isin;"),ut.ni=ut.contains=e(R,"\\ni ","&ni;"),ut.notni=ut.niton=ut.notcontains=ut.doesnotcontain=e(R,"\\not\\ni ","&#8716;"),ut.sub=ut.subset=e(R,"\\subset ","&sub;"),ut.sup=ut.supset=ut.superset=e(R,"\\supset ","&sup;"),ut.nsub=ut.notsub=ut.nsubset=ut.notsubset=e(R,"\\not\\subset ","&#8836;"),ut.nsup=ut.notsup=ut.nsupset=ut.notsupset=ut.nsuperset=ut.notsuperset=e(R,"\\not\\supset ","&#8837;"),ut.sube=ut.subeq=ut.subsete=ut.subseteq=e(R,"\\subseteq ","&sube;"),ut.supe=ut.supeq=ut.supsete=ut.supseteq=ut.supersete=ut.superseteq=e(R,"\\supseteq ","&supe;"),ut.nsube=ut.nsubeq=ut.notsube=ut.notsubeq=ut.nsubsete=ut.nsubseteq=ut.notsubsete=ut.notsubseteq=e(R,"\\not\\subseteq ","&#8840;"),ut.nsupe=ut.nsupeq=ut.notsupe=ut.notsupeq=ut.nsupsete=ut.nsupseteq=ut.notsupsete=ut.notsupseteq=ut.nsupersete=ut.nsuperseteq=ut.notsupersete=ut.notsuperseteq=e(R,"\\not\\supseteq ","&#8841;"),B=K(rt,function(t,e){t.init=function(t,n){e.init.call(this,t,"<big>"+n+"</big>")}}),ut["∑"]=ut.sum=ut.summation=e(B,"\\sum ","&sum;"),ut["∏"]=ut.prod=ut.product=e(B,"\\prod ","&prod;"),ut.coprod=ut.coproduct=e(B,"\\coprod ","&#8720;"),ut["∫"]=ut["int"]=ut.integral=e(B,"\\int ","&int;"),ut.N=ut.naturals=ut.Naturals=e(E,"\\mathbb{N}","&#8469;"),ut.P=ut.primes=ut.Primes=ut.projective=ut.Projective=ut.probability=ut.Probability=e(E,"\\mathbb{P}","&#8473;"),ut.Z=ut.integers=ut.Integers=e(E,"\\mathbb{Z}","&#8484;"),ut.Q=ut.rationals=ut.Rationals=e(E,"\\mathbb{Q}","&#8474;"),ut.R=ut.reals=ut.Reals=e(E,"\\mathbb{R}","&#8477;"),ut.C=ut.complex=ut.Complex=ut.complexes=ut.Complexes=ut.complexplane=ut.Complexplane=ut.ComplexPlane=e(E,"\\mathbb{C}","&#8450;"),ut.H=ut.Hamiltonian=ut.quaternions=ut.Quaternions=e(E,"\\mathbb{H}","&#8461;"),ut.quad=ut.emsp=e(E,"\\quad ","    "),ut.qquad=e(E,"\\qquad ","        "),ut.diamond=e(E,"\\diamond ","&#9671;"),ut.bigtriangleup=e(E,"\\bigtriangleup ","&#9651;"),ut.ominus=e(E,"\\ominus ","&#8854;"),ut.uplus=e(E,"\\uplus ","&#8846;"),ut.bigtriangledown=e(E,"\\bigtriangledown ","&#9661;"),ut.sqcap=e(E,"\\sqcap ","&#8851;"),ut.triangleleft=e(E,"\\triangleleft ","&#8882;"),ut.sqcup=e(E,"\\sqcup ","&#8852;"),ut.triangleright=e(E,"\\triangleright ","&#8883;"),ut.odot=e(E,"\\odot ","&#8857;"),ut.bigcirc=e(E,"\\bigcirc ","&#9711;"),ut.dagger=e(E,"\\dagger ","&#0134;"),ut.ddagger=e(E,"\\ddagger ","&#135;"),ut.wr=e(E,"\\wr ","&#8768;"),ut.amalg=e(E,"\\amalg ","&#8720;"),ut.models=e(E,"\\models ","&#8872;"),ut.prec=e(E,"\\prec ","&#8826;"),ut.succ=e(E,"\\succ ","&#8827;"),ut.preceq=e(E,"\\preceq ","&#8828;"),ut.succeq=e(E,"\\succeq ","&#8829;"),ut.simeq=e(E,"\\simeq ","&#8771;"),ut.mid=e(E,"\\mid ","&#8739;"),ut.ll=e(E,"\\ll ","&#8810;"),ut.gg=e(E,"\\gg ","&#8811;"),ut.parallel=e(E,"\\parallel ","&#8741;"),ut.bowtie=e(E,"\\bowtie ","&#8904;"),ut.sqsubset=e(E,"\\sqsubset ","&#8847;"),ut.sqsupset=e(E,"\\sqsupset ","&#8848;"),ut.smile=e(E,"\\smile ","&#8995;"),ut.sqsubseteq=e(E,"\\sqsubseteq ","&#8849;"),ut.sqsupseteq=e(E,"\\sqsupseteq ","&#8850;"),ut.doteq=e(E,"\\doteq ","&#8784;"),ut.frown=e(E,"\\frown ","&#8994;"),ut.vdash=e(E,"\\vdash ","&#8870;"),ut.dashv=e(E,"\\dashv ","&#8867;"),ut.longleftarrow=e(E,"\\longleftarrow ","&#8592;"),ut.longrightarrow=e(E,"\\longrightarrow ","&#8594;"),ut.Longleftarrow=e(E,"\\Longleftarrow ","&#8656;"),ut.Longrightarrow=e(E,"\\Longrightarrow ","&#8658;"),ut.longleftrightarrow=e(E,"\\longleftrightarrow ","&#8596;"),ut.updownarrow=e(E,"\\updownarrow ","&#8597;"),ut.Longleftrightarrow=e(E,"\\Longleftrightarrow ","&#8660;"),ut.Updownarrow=e(E,"\\Updownarrow ","&#8661;"),ut.mapsto=e(E,"\\mapsto ","&#8614;"),ut.nearrow=e(E,"\\nearrow ","&#8599;"),ut.hookleftarrow=e(E,"\\hookleftarrow ","&#8617;"),ut.hookrightarrow=e(E,"\\hookrightarrow ","&#8618;"),ut.searrow=e(E,"\\searrow ","&#8600;"),ut.leftharpoonup=e(E,"\\leftharpoonup ","&#8636;"),ut.rightharpoonup=e(E,"\\rightharpoonup ","&#8640;"),ut.swarrow=e(E,"\\swarrow ","&#8601;"),ut.leftharpoondown=e(E,"\\leftharpoondown ","&#8637;"),ut.rightharpoondown=e(E,"\\rightharpoondown ","&#8641;"),ut.nwarrow=e(E,"\\nwarrow ","&#8598;"),ut.ldots=e(E,"\\ldots ","&#8230;"),ut.cdots=e(E,"\\cdots ","&#8943;"),ut.vdots=e(E,"\\vdots ","&#8942;"),ut.ddots=e(E,"\\ddots ","&#8944;"),ut.surd=e(E,"\\surd ","&#8730;"),ut.triangle=e(E,"\\triangle ","&#9653;"),ut.ell=e(E,"\\ell ","&#8467;"),ut.top=e(E,"\\top ","&#8868;"),ut.flat=e(E,"\\flat ","&#9837;"),ut.natural=e(E,"\\natural ","&#9838;"),ut.sharp=e(E,"\\sharp ","&#9839;"),ut.wp=e(E,"\\wp ","&#8472;"),ut.bot=e(E,"\\bot ","&#8869;"),ut.clubsuit=e(E,"\\clubsuit ","&#9827;"),ut.diamondsuit=e(E,"\\diamondsuit ","&#9826;"),ut.heartsuit=e(E,"\\heartsuit ","&#9825;"),ut.spadesuit=e(E,"\\spadesuit ","&#9824;"),ut.oint=e(E,"\\oint ","&#8750;"),ut.bigcap=e(E,"\\bigcap ","&#8745;"),ut.bigcup=e(E,"\\bigcup ","&#8746;"),ut.bigsqcup=e(E,"\\bigsqcup ","&#8852;"),ut.bigvee=e(E,"\\bigvee ","&#8744;"),ut.bigwedge=e(E,"\\bigwedge ","&#8743;"),ut.bigodot=e(E,"\\bigodot ","&#8857;"),ut.bigotimes=e(E,"\\bigotimes ","&#8855;"),ut.bigoplus=e(E,"\\bigoplus ","&#8853;"),ut.biguplus=e(E,"\\biguplus ","&#8846;"),ut.lfloor=e(E,"\\lfloor ","&#8970;"),ut.rfloor=e(E,"\\rfloor ","&#8971;"),ut.lceil=e(E,"\\lceil ","&#8968;"),ut.rceil=e(E,"\\rceil ","&#8969;"),ut.slash=e(E,"\\slash ","&#47;"),ut.opencurlybrace=e(E,"\\opencurlybrace ","&#123;"),ut.closecurlybrace=e(E,"\\closecurlybrace ","&#125;"),ut.caret=e(E,"\\caret ","^"),ut.underscore=e(E,"\\underscore ","_"),ut.backslash=e(E,"\\backslash ","\\"),ut.vert=e(E,"|"),ut.perp=ut.perpendicular=e(E,"\\perp ","&perp;"),ut.nabla=ut.del=e(E,"\\nabla ","&nabla;"),ut.hbar=e(E,"\\hbar ","&#8463;"),ut.AA=ut.Angstrom=ut.angstrom=e(E,"\\text\\AA ","&#8491;"),ut.ring=ut.circ=ut.circle=e(E,"\\circ ","&#8728;"),ut.bull=ut.bullet=e(E,"\\bullet ","&bull;"),ut.setminus=ut.smallsetminus=e(E,"\\setminus ","&#8726;"),ut.not=ut["¬"]=ut.neg=e(E,"\\neg ","&not;"),ut["…"]=ut.dots=ut.ellip=ut.hellip=ut.ellipsis=ut.hellipsis=e(E,"\\dots ","&hellip;"),ut.converges=ut.darr=ut.dnarr=ut.dnarrow=ut.downarrow=e(E,"\\downarrow ","&darr;"),ut.dArr=ut.dnArr=ut.dnArrow=ut.Downarrow=e(E,"\\Downarrow ","&dArr;"),ut.diverges=ut.uarr=ut.uparrow=e(E,"\\uparrow ","&uarr;"),ut.uArr=ut.Uparrow=e(E,"\\Uparrow ","&uArr;"),ut.to=e(R,"\\to ","&rarr;"),ut.rarr=ut.rightarrow=e(E,"\\rightarrow ","&rarr;"),ut.implies=e(R,"\\Rightarrow ","&rArr;"),ut.rArr=ut.Rightarrow=e(E,"\\Rightarrow ","&rArr;"),ut.gets=e(R,"\\gets ","&larr;"),ut.larr=ut.leftarrow=e(E,"\\leftarrow ","&larr;"),ut.impliedby=e(R,"\\Leftarrow ","&lArr;"),ut.lArr=ut.Leftarrow=e(E,"\\Leftarrow ","&lArr;"),ut.harr=ut.lrarr=ut.leftrightarrow=e(E,"\\leftrightarrow ","&harr;"),ut.iff=e(R,"\\Leftrightarrow ","&hArr;"),ut.hArr=ut.lrArr=ut.Leftrightarrow=e(E,"\\Leftrightarrow ","&hArr;"),ut.Re=ut.Real=ut.real=e(E,"\\Re ","&real;"),ut.Im=ut.imag=ut.image=ut.imagin=ut.imaginary=ut.Imaginary=e(E,"\\Im ","&image;"),ut.part=ut.partial=e(E,"\\partial ","&part;"),ut.inf=ut.infin=ut.infty=ut.infinity=e(E,"\\infty ","&infin;"),ut.alef=ut.alefsym=ut.aleph=ut.alephsym=e(E,"\\aleph ","&alefsym;"),ut.xist=ut.xists=ut.exist=ut.exists=e(E,"\\exists ","&exist;"),ut.and=ut.land=ut.wedge=e(E,"\\wedge ","&and;"),ut.or=ut.lor=ut.vee=e(E,"\\vee ","&or;"),ut.o=ut.O=ut.empty=ut.emptyset=ut.oslash=ut.Oslash=ut.nothing=ut.varnothing=e(R,"\\varnothing ","&empty;"),ut.cup=ut.union=e(R,"\\cup ","&cup;"),ut.cap=ut.intersect=ut.intersection=e(R,"\\cap ","&cap;"),ut.deg=ut.degree=e(E,"^\\circ ","&deg;"),ut.ang=ut.angle=e(E,"\\angle ","&ang;"),$=K(rt,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","<span>"+t+"</span>")},t.respace=function(){this.jQ[0].className=this[Z]instanceof u||this[Z]instanceof v?"":"non-italicized-function"}}),ut.ln=ut.lg=ut.log=ut.span=ut.proj=ut.det=ut.dim=ut.min=ut.max=ut.mod=ut.lcm=ut.gcd=ut.gcf=ut.hcf=ut.lim=$,function(){var t,e=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(t in e)ut[e[t]]=ut[e[t]+"h"]=ut["a"+e[t]]=ut["arc"+e[t]]=ut["a"+e[t]+"h"]=ut["arc"+e[t]+"h"]=$}(),I=function(){function t(t){var e=st();return t.adopt(e,0,0),e}function e(t){var e,n=t[0]||st();for(e=1;e<t.length;e+=1)t[e].children().adopt(n,n.ends[Z],0);return n}var n=G.string,i=G.regex,r=G.letter,s=G.any,a=G.optWhitespace,o=G.succeed,c=G.fail,h=r.map(O),l=i(/^[^${}\\_^]/).map(E),u=i(/^[^\\a-eg-zA-Z]/).or(n("\\").then(i(/^[a-z]+/i).or(i(/^\s+/).result(" ")).or(s))).then(function(t){var e=ut[t];return e?e(t).parser():c("unknown command: \\"+t)}),p=u.or(h).or(l),f=n("{").then(function(){return m}).skip(n("}")),d=a.then(f.or(p.map(t))),m=d.many().map(e).skip(a),g=n("[").then(d.then(function(t){return"]"!==t.join("latex")?o(t):c()}).many().map(e).skip(a)).skip(n("]")),b=m;return b.block=d,b.optBlock=g,b}(),_=K(J,function(t){function e(t,e){var i,r,s,a;if(t.clearSelection().show(),t[Z][e])t.insAtLeftEnd(t[Z][e]);else if(t[X][e])t.insAtRightEnd(t[X][e]);else{i=t.parent;do{if(r=i[e],r&&("function"==typeof r&&(r=i[e](t)),r===!1||r instanceof st)){t.upDownCache[i.id]=J(t.parent,t[X],t[Z]),r instanceof st&&(s=t.upDownCache[r.id],s?s[Z]?t.insLeftOf(s[Z]):t.insAtRightEnd(s.parent):(a=n(t).left,t.insAtRightEnd(r),t.seekHoriz(a,r)));break}i=i.parent.parent}while(i)}return t}function n(t){var e=t.jQ.removeClass("cursor").offset();return t.jQ.addClass("cursor"),e}function r(t){t.upDownCache={}}t.init=function(t){this.parent=this.root=t;var e=this.jQ=this._jQ=Y('<span class="cursor">&#8203;</span>');this.blink=function(){e.toggleClass("blink")},this.upDownCache={}},t.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this[Z]?this.selection&&this.selection.ends[X][X]===this[X]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[Z].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},t.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=Y(),this},t.withDirInsertAt=function(t,e,n,i){var r=this.parent;this.parent=e,this[t]=n,this[-t]=i,r.blur()},t.insDirOf=function(t,e){return i(t),this.withDirInsertAt(t,e.parent,e[t],e),this.parent.jQ.addClass("hasCursor"),this.jQ.insDirOf(t,e.jQ),this},t.insLeftOf=function(t){return this.insDirOf(X,t)},t.insRightOf=function(t){return this.insDirOf(Z,t)},t.insAtDirEnd=function(t,e){return i(t),this.withDirInsertAt(t,e,0,e.ends[t]),t===X&&e.textarea?this.jQ.insDirOf(-t,e.textarea):this.jQ.insAtDirEnd(t,e.jQ),e.focus(),this},t.insAtLeftEnd=function(t){return this.insAtDirEnd(X,t)},t.insAtRightEnd=function(t){return this.insAtDirEnd(Z,t)},t.hopDir=function(t){return i(t),this.jQ.insDirOf(t,this[t].jQ),this[-t]=this[t],this[t]=this[t][t],this},t.hopLeft=function(){return this.hopDir(X)},t.hopRight=function(){return this.hopDir(Z)},t.moveDirWithin=function(t,e){if(i(t),this[t])this[t].ends[-t]?this.insAtDirEnd(-t,this[t].ends[-t]):this.hopDir(t);else{if(this.parent===e)return;this.parent[t]?this.insAtDirEnd(-t,this.parent[t]):this.insDirOf(t,this.parent.parent)}},t.moveLeftWithin=function(t){return this.moveDirWithin(X,t)},t.moveRightWithin=function(t){return this.moveDirWithin(Z,t)},t.moveDir=function(t){return i(t),r(this),this.selection?this.insDirOf(t,this.selection.ends[t]).clearSelection():this.moveDirWithin(t,this.root),this.show()},t.moveLeft=function(){return this.moveDir(X)},t.moveRight=function(){return this.moveDir(Z)},t.moveUp=function(){return e(this,"up")},t.moveDown=function(){return e(this,"down")},t.seek=function(t,e,n){r(this);var i,s,a=this.clearSelection().show();return t.hasClass("empty")?(a.insAtLeftEnd(nt[t.attr(P)]),a):(i=nt[t.attr(F)],i instanceof rt?(t.outerWidth()>2*(e-t.offset().left)?a.insLeftOf(i):a.insRightOf(i),a):(i||(s=nt[t.attr(P)],s||(t=t.parent(),i=nt[t.attr(F)],i||(s=nt[t.attr(P)],s||(s=a.root)))),i?a.insRightOf(i):a.insAtRightEnd(s),a.seekHoriz(e,a.root)))},t.seekHoriz=function(t,e){var i,r=this,s=n(r).left-t;do r.moveLeftWithin(e),i=s,s=n(r).left-t;while(s>0&&(r[X]||r.parent!==e));return-s>i&&r.moveRightWithin(e),r},t.writeLatex=function(t){var e,n,i,s=this;return r(s),s.show().deleteSelection(),e=G.all,n=G.eof,i=I.skip(n).or(e.result(!1)).parse(t),i&&(i.children().adopt(s.parent,s[X],s[Z]),nt.jQize(i.join("html")).insertBefore(s.jQ),s[X]=i.ends[Z],i.finalizeInsert(),s.parent.bubble("redraw")),this.hide()},t.write=function(t){var e=this.prepareWrite();return this.insertCh(t,e)},t.insertCh=function(t,e){return this.parent.write(this,t,e),this},t.insertCmd=function(t,e){var n=ut[t];return n?(n=n(t),e&&n.replaces(e),n.createLeftOf(this)):(n=q(),n.replaces(t),n.ends[X].focus=function(){return delete this.focus,this},n.createLeftOf(this),this.insRightOf(n),e&&e.remove()),this},t.unwrapGramp=function(){var t=this.parent.parent,e=t.parent,n=t[Z],i=t[X];if(t.disown().eachChild(function(r){r.isEmpty()||(r.children().adopt(e,i,n).each(function(e){e.jQ.insertBefore(t.jQ.first())}),i=r.ends[Z])}),!this[Z])if(this[X])this[Z]=this[X][Z];else for(;!this[Z];){if(this.parent=this.parent[Z],!this.parent){this[Z]=t[Z],this.parent=e;break}this[Z]=this.parent.ends[X]}this[Z]?this.insLeftOf(this[Z]):this.insAtRightEnd(e),t.jQ.remove(),t[X]&&t[X].respace(),t[Z]&&t[Z].respace()},t.deleteDir=function(t){if(i(t),r(this),this.show(),this.deleteSelection());else if(this[t])this[t].isEmpty()?this[t]=this[t].remove()[t]:this.selectDir(t);else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insDirOf(-t,this.parent.parent).deleteDir(t);this.unwrapGramp()}return this[X]&&this[X].respace(),this[Z]&&this[Z].respace(),this.parent.bubble("redraw"),this},t.backspace=function(){return this.deleteDir(X)},t.deleteForward=function(){return this.deleteDir(Z)},t.selectFrom=function(t){var e,n,i,r,s,a,o=this,c=t;t:for(;;){for(e=this;e!==o.parent.parent;e=e.parent.parent)if(e.parent===c.parent){i=e,r=c;break t}for(n=t;n!==c.parent.parent;n=n.parent.parent)if(o.parent===n.parent){i=o,r=n;break t}o.parent.parent&&(o=o.parent.parent),c.parent.parent&&(c=c.parent.parent)}if(i[Z]!==r){for(a=i;a;a=a[Z])if(a===r[X]){s=!0;break}s||(s=r,r=i,i=s)}this.hide().selection=W(i[X][Z]||i.parent.ends[X],r[Z][X]||r.parent.ends[Z]),this.insRightOf(r[Z][X]||r.parent.ends[Z]),this.root.selectionChanged()},t.selectDir=function(t){if(i(t),r(this),this.selection)if(this.selection.ends[t]===this[-t])this[t]?this.hopDir(t).selection.extendDir(t):this.parent!==this.root&&this.insDirOf(t,this.parent.parent).selection.levelUp();else{if(this.hopDir(t),this.selection.ends[t]===this.selection.ends[-t])return void this.clearSelection().show();this.selection.retractDir(t)}else{if(this[t])this.hopDir(t);else{if(this.parent===this.root)return;this.insDirOf(t,this.parent.parent)}this.hide().selection=W(this[-t])}this.root.selectionChanged()},t.selectLeft=function(){return this.selectDir(X)},t.selectRight=function(){return this.selectDir(Z)},t.prepareMove=function(){return r(this),this.show().clearSelection()},t.prepareEdit=function(){return r(this),this.show().deleteSelection()},t.prepareWrite=function(){return r(this),this.show().replaceSelection()},t.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},t.deleteSelection=function(){return this.selection?(this[X]=this.selection.ends[X][X],this[Z]=this.selection.ends[Z][Z],this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1},t.replaceSelection=function(){var t=this.selection;return t&&(this[X]=t.ends[X][X],this[Z]=t.ends[Z][Z],delete this.selection),t}}),W=K(at,function(t,e){t.init=function(){var t=this;e.init.apply(t,arguments),t.jQwrap(t.jQ)},t.jQwrap=function(t){this.jQ=t.wrapAll('<span class="selection"></span>').parent()},t.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),e.adopt.apply(this,arguments)},t.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},t.levelUp=function(){var t=this,e=t.ends[X]=t.ends[Z]=t.ends[Z].parent.parent;return t.clear().jQwrap(e.jQ),t},t.extendDir=function(t){return i(t),this.ends[t]=this.ends[t][t],this.ends[t].jQ.insAtDirEnd(t,this.jQ),this},t.extendLeft=function(){return this.extendDir(X)},t.extendRight=function(){return this.extendDir(Z)},t.retractDir=function(t){i(t),this.ends[-t].jQ.insDirOf(-t,this.jQ),this.ends[-t]=this.ends[-t][t]},t.retractRight=function(){return this.retractDir(Z)},t.retractLeft=function(){return this.retractDir(X)}}),M.fn.mathquill=function(t,e){var n,i,s,a,o;switch(t){case"redraw":return this.each(function(){var t=Y(this).attr(P),e=t&&nt[t];e&&!function n(t){t.eachChild(n),t.redraw&&t.redraw()}(e)});case"revert":return this.each(function(){var t=Y(this).attr(P),e=t&&nt[t];e&&e.revert&&e.revert()});case"latex":return arguments.length>1?this.each(function(){var t=Y(this).attr(P),n=t&&nt[t];n&&n.renderLatex(e)}):(n=Y(this).attr(P),i=n&&nt[n],i&&i.latex());case"text":return n=Y(this).attr(P),i=n&&nt[n],i&&i.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var t=Y(this).attr(P),n=t&&nt[t],i=n&&n.cursor;i&&i.writeLatex(e)});case"cmd":if(arguments.length>1)return this.each(function(){var t,n=Y(this).attr(P),i=n&&nt[n],r=i&&i.cursor;r&&(t=r.prepareWrite(),/^\\[a-z]+$/i.test(e)?r.insertCmd(e.slice(1),t):r.insertCh(e,t))});case"cursor":if(arguments.length>1)return this.each(function(){var t=Y(this).attr(P),n=t&&nt[t],i=n&&n.cursor;i&&e in i&&"function"==typeof i[e]&&i[e]()});default:return s="textbox"===t,a=s||"editable"===t,o=s?ht:ot,this.each(function(){r(Y(this),o(),s,a)})}},M(function(){M(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),M(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),M(".mathquill-embedded-latex").mathquill()})}();
